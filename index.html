<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت هوشمند قبض آب</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        input { width: 100%; box-sizing: border-box; }
        button { margin: 5px; }
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }
        .tier { margin-bottom: 10px; }
    </style>
</head>
<body>
    <h1>مدیریت هوشمند قبض آب</h1>

    <button id="settingsBtn">تنظیمات</button>
    <button id="historyBtn">تاریخچه</button>

    <div>
        <label>نام دوره:</label>
        <input type="text" id="periodName">
    </div>
    <div>
        <label>تاریخ قبض:</label>
        <input type="date" id="billDate">
    </div>
    <div>
        <label>مبلغ کل قبض (تومان):</label>
        <input type="number" id="totalBill" min="0">
    </div>

    <table id="unitsTable">
        <thead>
            <tr>
                <th>شماره واحد</th>
                <th>نام واحد</th>
                <th>قرائت قبلی</th>
                <th>قرائت فعلی</th>
                <th>میزان مصرف (متر مکعب)</th>
                <th>پله مصرف</th>
                <th>مبلغ (تومان)</th>
            </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
            <tr>
                <td colspan="6">جمع کل</td>
                <td id="totalAmount">0</td>
            </tr>
            <tr>
                <td colspan="6">مابه التفاوت (مبلغ قبض - جمع مبالغ)</td>
                <td id="difference">0</td>
            </tr>
        </tfoot>
    </table>

    <div>
        <button id="savePeriod">ذخیره دوره فعلی</button>
        <button id="newPeriod">شروع دوره جدید</button>
        <button id="exportPDF">خروجی PDF</button>
        <button id="exportExcel">خروجی Excel</button>
        <button id="importExcel">ورود از Excel</button>
    </div>

    <!-- Modal تنظیمات -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>تنظیمات محاسبه هزینه</h2>
            <label><input type="radio" name="calcMode" value="manual" checked> پلکانی دستی</label>
            <label><input type="radio" name="calcMode" value="auto"> تنظیم خودکار</label>

            <div id="manualTiersSection">
                <p>در این حالت، تعرفه هر پلکان مصرف را به صورت دستی وارد می‌کنید.</p>
                <div id="manualTiers"></div>
                <button id="addManualTier">+ افزودن پلکان</button>
            </div>

            <div id="autoTiersSection" style="display: none;">
                <p>در این حالت، برنامه با دریافت ضرایب مصرف، رقم مبنا را طوری محاسبه می‌کند که جمع مبالغ واحدها برابر با مبلغ کل قبض شود.</p>
                <div id="autoTiers"></div>
                <button id="addAutoTier">+ افزودن پلکان</button>
            </div>

            <button id="saveSettings">ذخیره تنظیمات</button>
        </div>
    </div>

    <!-- Modal تاریخچه -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>تاریخچه دوره‌ها</h2>
            <ul id="historyList"></ul>
        </div>
    </div>

    <script>
        // آدرس‌های backend PHP (جایگزین با آدرس واقعی سرور خود کنید، مثلاً https://your-server.com/)
        const API_BASE = 'https://your-server-domain.com/'; // آدرس سرور PHP خود را اینجا بگذارید
        const GET_DATA_URL = API_BASE + 'get_data.php';
        const SAVE_DATA_URL = API_BASE + 'save_data.php';

        let state = {
            units: [],
            settings: {
                calculationMode: 'manual',
                manualTiers: [],
                autoTiers: []
            },
            periodInfo: { name: '', date: '', totalBill: 0 },
            history: [] // برای ذخیره تاریخچه محلی (اگر backend گسترش یابد، از دیتابیس بخوانید)
        };

        // لود داده‌ها از backend هنگام بارگذاری صفحه
        async function loadData() {
            try {
                const response = await fetch(GET_DATA_URL);
                const data = await response.json();
                state.units = data.units || [];
                state.settings = data.settings || state.settings;
                document.getElementById('periodName').value = data.periodInfo?.name || '';
                document.getElementById('billDate').value = data.periodInfo?.date || '';
                document.getElementById('totalBill').value = data.periodInfo?.totalBill || 0;
                renderUnitsTable();
                updateCalculationMode();
            } catch (error) {
                console.error('خطا در لود داده‌ها:', error);
            }
        }

        // ذخیره داده‌ها در backend
        async function saveData() {
            try {
                const response = await fetch(SAVE_DATA_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        units: state.units,
                        settings: state.settings,
                        periodInfo: {
                            name: document.getElementById('periodName').value,
                            date: document.getElementById('billDate').value,
                            totalBill: parseFloat(document.getElementById('totalBill').value) || 0
                        }
                    })
                });
                const result = await response.json();
                if (result.success) {
                    alert('اطلاعات ذخیره شد.');
                } else {
                    alert('خطا در ذخیره: ' + result.message);
                }
            } catch (error) {
                console.error('خطا در ذخیره داده‌ها:', error);
            }
        }

        // رندر جدول واحدها
        function renderUnitsTable() {
            const tbody = document.querySelector('#unitsTable tbody');
            tbody.innerHTML = '';
            state.units.forEach((unit, index) => {
                const consumption = unit.current - unit.prev;
                const tier = calculateTier(consumption);
                const amount = calculateAmount(consumption);
                const row = `
                    <tr>
                        <td>${unit.id}</td>
                        <td><input type="text" value="${unit.name}" oninput="updateUnit(${index}, 'name', this.value)"></td>
                        <td><input type="number" value="${unit.prev}" oninput="updateUnit(${index}, 'prev', this.value)"></td>
                        <td><input type="number" value="${unit.current}" oninput="updateUnit(${index}, 'current', this.value)"></td>
                        <td>${consumption.toFixed(2)}</td>
                        <td>${tier}</td>
                        <td>${amount.toFixed(0)}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            updateTotals();
        }

        // بروزرسانی واحد
        function updateUnit(index, field, value) {
            state.units[index][field] = field === 'name' ? value : parseFloat(value) || 0;
            renderUnitsTable();
        }

        // محاسبه پله مصرف (فرض ساده: بر اساس مصرف)
        function calculateTier(consumption) {
            // منطق پله‌ها بر اساس تنظیمات
            if (state.settings.calculationMode === 'manual') {
                let tier = 1;
                state.settings.manualTiers.forEach(t => {
                    if (consumption > t.max) tier++;
                });
                return tier;
            } else {
                // برای auto، منطق مشابه اما با ضریب
                return 'خودکار';
            }
        }

        // محاسبه مبلغ
        function calculateAmount(consumption) {
            if (state.settings.calculationMode === 'manual') {
                let amount = 0;
                let remaining = consumption;
                state.settings.manualTiers.forEach(t => {
                    const tierConsumption = Math.min(remaining, t.max - (t.min || 0));
                    amount += tierConsumption * t.rate;
                    remaining -= tierConsumption;
                });
                return amount;
            } else {
                // برای auto: محاسبه بر اساس ضریب و تنظیم برای برابر شدن با totalBill
                const totalConsumption = state.units.reduce((sum, u) => sum + (u.current - u.prev), 0);
                const baseRate = state.periodInfo.totalBill / totalConsumption;
                return consumption * baseRate; // ساده‌سازی، می‌توانید پیچیده‌تر کنید
            }
        }

        // بروزرسانی جمع کل و مابه‌التفاوت
        function updateTotals() {
            const totalAmount = state.units.reduce((sum, u) => sum + calculateAmount(u.current - u.prev), 0);
            const difference = state.periodInfo.totalBill - totalAmount;
            document.getElementById('totalAmount').textContent = totalAmount.toFixed(0);
            document.getElementById('difference').textContent = difference.toFixed(0);
        }

        // مدیریت modalها
        const settingsModal = document.getElementById('settingsModal');
        const historyModal = document.getElementById('historyModal');
        const closes = document.getElementsByClassName('close');

        document.getElementById('settingsBtn').onclick = () => settingsModal.style.display = 'block';
        document.getElementById('historyBtn').onclick = () => {
            renderHistory();
            historyModal.style.display = 'block';
        };

        for (let close of closes) {
            close.onclick = () => {
                settingsModal.style.display = 'none';
                historyModal.style.display = 'none';
            };
        }

        window.onclick = (event) => {
            if (event.target == settingsModal) settingsModal.style.display = 'none';
            if (event.target == historyModal) historyModal.style.display = 'none';
        };

        // مدیریت حالت محاسبه
        const radios = document.querySelectorAll('input[name="calcMode"]');
        radios.forEach(radio => {
            radio.onchange = () => {
                state.settings.calculationMode = radio.value;
                updateCalculationMode();
            };
        });

        function updateCalculationMode() {
            document.querySelector(`input[value="${state.settings.calculationMode}"]`).checked = true;
            document.getElementById('manualTiersSection').style.display = state.settings.calculationMode === 'manual' ? 'block' : 'none';
            document.getElementById('autoTiersSection').style.display = state.settings.calculationMode === 'auto' ? 'block' : 'none';
            renderTiers('manual');
            renderTiers('auto');
        }

        // رندر پلکان‌ها
        function renderTiers(mode) {
            const container = document.getElementById(`${mode}Tiers`);
            container.innerHTML = '';
            state.settings[`${mode}Tiers`].forEach((tier, index) => {
                const div = document.createElement('div');
                div.className = 'tier';
                div.innerHTML = `
                    <label>از:</label><input type="number" value="${tier.min || 0}" oninput="updateTier('${mode}', ${index}, 'min', this.value)">
                    <label>تا:</label><input type="number" value="${tier.max}" oninput="updateTier('${mode}', ${index}, 'max', this.value)">
                    <label>${mode === 'manual' ? 'تعرفه (تومان/مترمکعب)' : 'ضریب'}:</label><input type="number" value="${tier.rate}" oninput="updateTier('${mode}', ${index}, 'rate', this.value)">
                    <button onclick="removeTier('${mode}', ${index})">حذف</button>
                `;
                container.appendChild(div);
            });
        }

        // بروزرسانی پلکان
        function updateTier(mode, index, field, value) {
            state.settings[`${mode}Tiers`][index][field] = parseFloat(value) || 0;
            renderUnitsTable();
        }

        // افزودن پلکان
        document.getElementById('addManualTier').onclick = () => addTier('manual');
        document.getElementById('addAutoTier').onclick = () => addTier('auto');

        function addTier(mode) {
            state.settings[`${mode}Tiers`].push({ min: 0, max: 0, rate: 0 });
            renderTiers(mode);
        }

        // حذف پلکان
        function removeTier(mode, index) {
            state.settings[`${mode}Tiers`].splice(index, 1);
            renderTiers(mode);
            renderUnitsTable();
        }

        // ذخیره تنظیمات
        document.getElementById('saveSettings').onclick = () => {
            saveData();
            settingsModal.style.display = 'none';
        };

        // ذخیره دوره فعلی
        document.getElementById('savePeriod').onclick = () => {
            state.periodInfo = {
                name: document.getElementById('periodName').value,
                date: document.getElementById('billDate').value,
                totalBill: parseFloat(document.getElementById('totalBill').value) || 0
            };
            saveData();
            // اضافه به تاریخچه محلی (برای backend واقعی، جدول periods اضافه کنید)
            state.history.push({ ...state.periodInfo, units: [...state.units] });
        };

        // شروع دوره جدید
        document.getElementById('newPeriod').onclick = () => {
            state.units.forEach(u => u.prev = u.current);
            state.periodInfo = { name: '', date: '', totalBill: 0 };
            document.getElementById('periodName').value = '';
            document.getElementById('billDate').value = '';
            document.getElementById('totalBill').value = 0;
            renderUnitsTable();
            saveData();
        };

        // رندر تاریخچه
        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            state.history.forEach((period, index) => {
                const li = document.createElement('li');
                li.textContent = `${period.name} - ${period.date} - مبلغ: ${period.totalBill}`;
                // می‌توانید جزئیات بیشتری اضافه کنید
                list.appendChild(li);
            });
        }

        // خروجی PDF (با jsPDF - لایبرری را اضافه کنید)
        document.getElementById('exportPDF').onclick = () => {
            // برای واقعی کردن، jsPDF را include کنید: <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text('مدیریت قبض آب', 10, 10);
            // اضافه کردن جدول و داده‌ها
            doc.save('bill.pdf');
        };

        // خروجی Excel (با SheetJS - لایبرری را اضافه کنید)
        document.getElementById('exportExcel').onclick = () => {
            // برای واقعی کردن، SheetJS را include کنید: <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
            const ws = XLSX.utils.json_to_sheet(state.units);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Units');
            XLSX.writeFile(wb, 'bill.xlsx');
        };

        // ورود از Excel (فایل آپلود)
        document.getElementById('importExcel').onclick = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const data = evt.target.result;
                    const wb = XLSX.read(data, { type: 'binary' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    state.units = XLSX.utils.sheet_to_json(ws);
                    renderUnitsTable();
                    saveData();
                };
                reader.readAsBinaryString(file);
            };
            input.click();
        };

        // بروزرسانی هنگام تغییر مبلغ کل
        document.getElementById('totalBill').oninput = () => {
            state.periodInfo.totalBill = parseFloat(this.value) || 0;
            renderUnitsTable();
        };

        // لود اولیه
        loadData();

        // توجه: برای افزودن واحد جدید، می‌توانید دکمه‌ای اضافه کنید
        // مثلاً: state.units.push({id: state.units.length + 1, name: '', prev: 0, current: 0}); renderUnitsTable();
    </script>
</body>
</html>
