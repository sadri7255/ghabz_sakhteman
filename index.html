<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت هوشمند قبض آب</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Jalali Date Picker -->
    <link rel="stylesheet" href="https://unpkg.com/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.css">
    <script type="text/javascript" src="https://unpkg.com/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.js"></script>
    
    <!-- Vazirmatn Font -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- html2canvas for Image Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Styles using Tailwind -->
    <style type="text/tailwindcss">
        body {
            font-family: 'Vazirmatn', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #aab5c0; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #888; }

        @layer components {
            .card {
                @apply bg-white/80 backdrop-blur-sm border border-gray-200/80 rounded-2xl shadow-lg transition-all duration-300;
            }
            .input-field {
                @apply w-full bg-gray-50/80 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-800 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-300;
            }
            .btn {
                @apply flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl font-semibold shadow-md transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2;
            }
            .btn-primary {
                @apply bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500;
            }
            .btn-secondary {
                @apply bg-gray-200 text-gray-800 hover:bg-gray-300 focus:ring-gray-400;
            }
            .btn-icon {
                 @apply bg-white/80 backdrop-blur-sm text-gray-600 hover:text-blue-600 hover:bg-white rounded-full p-2.5 shadow-md transition-all duration-300;
            }
            .modal-backdrop {
                @apply fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300;
            }
            .modal-backdrop.visible {
                @apply opacity-100 pointer-events-auto;
            }
            .modal-content {
                @apply bg-white rounded-2xl shadow-2xl p-6 w-full max-w-lg transform scale-95 transition-all duration-300;
            }
            .modal-backdrop.visible .modal-content {
                @apply scale-100;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
        <div class="container mx-auto p-4 md:p-6 max-w-7xl">
            
            <!-- Header -->
            <header class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center shadow-lg">
                        <i data-lucide="droplets" class="w-7 h-7"></i>
                    </div>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">مدیریت قبض آب</h1>
                </div>
                <div class="flex items-center gap-2 relative">
                    <button id="settings-btn" class="btn-icon" title="تنظیمات">
                        <i data-lucide="settings-2" class="w-5 h-5"></i>
                    </button>
                    <button id="history-btn" class="btn-icon" title="تاریخچه">
                        <i data-lucide="history" class="w-5 h-5"></i>
                    </button>
                    <div class="relative">
                        <button id="actions-menu-btn" class="btn btn-primary">
                            <i data-lucide="menu" class="w-5 h-5"></i>
                            <span class="hidden sm:inline">عملیات</span>
                        </button>
                        <div id="actions-menu" class="absolute top-full mt-2 left-0 w-56 bg-white rounded-xl shadow-2xl border hidden z-10 origin-top-left transition-transform duration-200">
                            <ul class="text-gray-700 p-2">
                                <li><a href="#" id="save-period-btn" class="flex items-center gap-3 w-full text-right px-3 py-2 text-sm hover:bg-gray-100 rounded-lg"><i data-lucide="save" class="w-4 h-4"></i>ذخیره دوره</a></li>
                                <li><a href="#" id="new-period-btn" class="flex items-center gap-3 w-full text-right px-3 py-2 text-sm hover:bg-gray-100 rounded-lg"><i data-lucide="file-plus-2" class="w-4 h-4"></i>شروع دوره جدید</a></li>
                                <li class="border-t my-2"></li>
                                <li><a href="#" id="export-excel-btn" class="flex items-center gap-3 w-full text-right px-3 py-2 text-sm hover:bg-gray-100 rounded-lg"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i>خروجی Excel</a></li>
                                <li><a href="#" id="export-image-btn" class="flex items-center gap-3 w-full text-right px-3 py-2 text-sm hover:bg-gray-100 rounded-lg"><i data-lucide="image" class="w-4 h-4"></i>خروجی عکس</a></li>
                                <li class="border-t my-2"></li>
                                <li><a href="#" id="backup-btn" class="flex items-center gap-3 w-full text-right px-3 py-2 text-sm hover:bg-gray-100 rounded-lg"><i data-lucide="download" class="w-4 h-4"></i>دریافت پشتیبان</a></li>
                                <li><label for="restore-input" class="flex items-center gap-3 w-full text-right px-3 py-2 text-sm hover:bg-gray-100 rounded-lg cursor-pointer"><i data-lucide="upload" class="w-4 h-4"></i>بازیابی پشتیبان</label></li>
                            </ul>
                            <input type="file" id="restore-input" accept=".json" class="hidden">
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="space-y-6">
                <!-- Period Info Card -->
                <div class="card p-4 md:p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="period-name" class="font-semibold mb-2 block text-gray-600 text-sm">نام دوره</label>
                            <input type="text" id="period-name" placeholder="مثال: تابستان ۱۴۰۳" class="input-field">
                        </div>
                        <div>
                            <label for="bill-date" class="font-semibold mb-2 block text-gray-600 text-sm">تاریخ قبض</label>
                            <input type="text" id="bill-date" data-jdp placeholder="تاریخ را انتخاب کنید" class="input-field">
                        </div>
                        <div>
                            <label for="total-bill-amount" class="font-semibold mb-2 block text-gray-600 text-sm">مبلغ کل قبض (تومان)</label>
                            <input type="text" id="total-bill-amount" placeholder="مبلغ کل را وارد کنید" inputmode="numeric" class="input-field">
                        </div>
                    </div>
                </div>

                <!-- Table Card -->
                <div class="card overflow-hidden">
                    <div class="overflow-x-auto">
                        <table id="main-table" class="w-full text-center">
                            <thead class="bg-gray-700 text-white text-sm">
                                <tr>
                                    <th class="p-4 font-semibold">واحد</th>
                                    <th class="p-4 font-semibold text-right">نام</th>
                                    <th class="p-4 font-semibold">قرائت قبلی</th>
                                    <th class="p-4 font-semibold">قرائت فعلی</th>
                                    <th class="p-4 font-semibold">مصرف (متر مکعب)</th>
                                    <th class="p-4 font-semibold">پله</th>
                                    <th class="p-4 font-semibold">مبلغ (تومان)</th>
                                </tr>
                            </thead>
                            <tbody id="table-body" class="divide-y divide-gray-200">
                                <!-- Rows will be injected by JS -->
                            </tbody>
                            <tfoot class="font-bold text-white text-sm">
                                <tr class="bg-gray-600">
                                    <td colspan="4" class="p-4">جمع کل</td>
                                    <td id="total-consumption" class="p-4">۰</td>
                                    <td class="p-4"></td>
                                    <td id="total-calculated-amount" class="p-4">۰</td>
                                </tr>
                                <tr class="bg-gray-800">
                                    <td colspan="5" class="p-4">مابه التفاوت</td>
                                    <td colspan="2" id="difference-amount" class="p-4">۰</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="settings-modal" class="modal-backdrop">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">تنظیمات محاسبه هزینه</h2>
                <button class="modal-close-btn text-gray-400 hover:text-gray-800"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <div class="mb-6 p-1 bg-gray-100 rounded-xl flex justify-center gap-1">
                <label class="w-full text-center py-2.5 rounded-lg cursor-pointer transition-colors duration-300"><input type="radio" name="calc-mode" value="manual" class="hidden"> پلکانی دستی</label>
                <label class="w-full text-center py-2.5 rounded-lg cursor-pointer transition-colors duration-300"><input type="radio" name="calc-mode" value="auto" class="hidden"> تنظیم خودکار</label>
            </div>

            <div id="manual-settings">
                <div id="manual-tiers-container" class="space-y-3 max-h-64 overflow-y-auto pr-2"></div>
                <button id="add-manual-tier-btn" class="mt-4 btn btn-secondary w-full">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i> افزودن پلکان دستی
                </button>
            </div>
            <div id="auto-settings" class="hidden">
                <div id="auto-tiers-container" class="space-y-3 max-h-64 overflow-y-auto pr-2"></div>
                <button id="add-auto-tier-btn" class="mt-4 btn btn-secondary w-full">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i> افزودن پلکان خودکار
                </button>
            </div>
            <hr class="my-6">
            <button id="save-settings-btn" class="btn btn-primary w-full bg-green-600 hover:bg-green-700 focus:ring-green-500">
                 <i data-lucide="check-circle" class="w-5 h-5"></i> ذخیره تنظیمات
            </button>
        </div>
    </div>

    <div id="history-modal" class="modal-backdrop">
        <div class="modal-content max-w-xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">تاریخچه دوره‌ها</h2>
                <button class="modal-close-btn text-gray-400 hover:text-gray-800"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="history-container" class="overflow-y-auto pr-2 -mr-2"></div>
        </div>
    </div>
    
    <div id="message-modal" class="modal-backdrop z-[100]">
        <div class="modal-content max-w-sm text-center">
            <div id="message-icon" class="mx-auto mb-4"></div>
            <p id="message-text" class="mb-6 text-gray-700 text-lg"></p>
            <div id="message-buttons" class="flex justify-center gap-4"></div>
        </div>
    </div>

    <!-- Hidden container for rendering the image content before export -->
    <div id="image-export-container" class="fixed top-0 left-0 -z-50 opacity-0 pointer-events-none"></div>

    <script>
    // All JavaScript from script.js goes here
    window.onload = () => {
        // کلیدهای مورد استفاده برای ذخیره‌سازی در حافظه مرورگر
        const DB_STATE_KEY = 'waterBillAppState_v2';
        const DB_HISTORY_KEY = 'waterBillAppHistory_v2';

        const DOM = {
            tableBody: document.getElementById('table-body'),
            totalConsumption: document.getElementById('total-consumption'),
            totalCalculatedAmount: document.getElementById('total-calculated-amount'),
            differenceAmount: document.getElementById('difference-amount'),
            periodNameInput: document.getElementById('period-name'),
            billDateInput: document.getElementById('bill-date'),
            totalBillAmountInput: document.getElementById('total-bill-amount'),
            actionsMenuBtn: document.getElementById('actions-menu-btn'),
            actionsMenu: document.getElementById('actions-menu'),
            restoreInput: document.getElementById('restore-input'),
            settingsModal: document.getElementById('settings-modal'),
            historyModal: document.getElementById('history-modal'),
            messageModal: document.getElementById('message-modal'),
            manualSettings: document.getElementById('manual-settings'),
            autoSettings: document.getElementById('auto-settings'),
            manualTiersContainer: document.getElementById('manual-tiers-container'),
            autoTiersContainer: document.getElementById('auto-tiers-container'),
            historyContainer: document.getElementById('history-container'),
            messageText: document.getElementById('message-text'),
            messageButtons: document.getElementById('message-buttons'),
            messageIcon: document.getElementById('message-icon'),
        };

        let state = {};

        const toEnglishDigits = str => String(str).replace(/[\u0660-\u0669\u06F0-\u06F9]/g, c => c.charCodeAt(0) & 0xf);
        const getRawNumber = formattedStr => parseFloat(toEnglishDigits(String(formattedStr)).replace(/[,٬]/g, '')) || 0;
        const formatNumber = num => isNaN(num) ? '۰' : Math.round(num).toLocaleString('fa-IR');

        // --- MODAL FUNCTIONS ---
        function displayModal(text, buttonsHtml = '', icon = 'info') {
            const icons = {
                'success': '<div class="w-16 h-16 rounded-full bg-green-100 flex items-center justify-center"><i data-lucide="check" class="w-10 h-10 text-green-600"></i></div>',
                'error': '<div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center"><i data-lucide="alert-triangle" class="w-10 h-10 text-red-600"></i></div>',
                'confirm': '<div class="w-16 h-16 rounded-full bg-yellow-100 flex items-center justify-center"><i data-lucide="help-circle" class="w-10 h-10 text-yellow-600"></i></div>',
                'info': '<div class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center"><i data-lucide="info" class="w-10 h-10 text-blue-600"></i></div>',
                'loading': '<div class="w-16 h-16 flex items-center justify-center"><i data-lucide="loader-2" class="w-10 h-10 text-gray-500 animate-spin"></i></div>',
            };
            DOM.messageIcon.innerHTML = icons[icon] || icons['info'];
            DOM.messageText.textContent = text;
            DOM.messageButtons.innerHTML = buttonsHtml;
            DOM.messageModal.classList.add('visible');
            lucide.createIcons();
        }

        function hideModal() {
            DOM.messageModal.classList.remove('visible');
        }

        function showMessage(text, options = {}) {
            const {
                icon = 'info',
                buttons = [{ text: 'باشه', class: 'btn-primary', resolveValue: true }]
            } = options;

            return new Promise(resolve => {
                const buttonsHtml = buttons.map((btnInfo, index) =>
                    `<button data-resolve-index="${index}" class="btn ${btnInfo.class}">${btnInfo.text}</button>`
                ).join('');

                displayModal(text, buttonsHtml, icon);

                const buttonElements = DOM.messageButtons.querySelectorAll('button');
                buttonElements.forEach(button => {
                    button.onclick = () => {
                        const index = parseInt(button.dataset.resolveIndex);
                        hideModal();
                        resolve(buttons[index].resolveValue);
                    };
                });
            });
        }

        // --- DATA MANAGEMENT FUNCTIONS ---
        function saveState() {
            try {
                localStorage.setItem(DB_STATE_KEY, JSON.stringify(state));
            } catch (error) {
                console.error('Failed to save state:', error);
                showMessage('خطا در ذخیره اطلاعات در حافظه مرورگر.', { icon: 'error' });
            }
        }

        function loadState() {
            try {
                const savedState = localStorage.getItem(DB_STATE_KEY);
                if (savedState) {
                    state = JSON.parse(savedState);
                } else {
                    state = {
                        units: Array.from({ length: 66 }, (_, i) => ({ id: i + 1, name: i === 64 ? 'عمومی' : (i === 65 ? 'تجاری' : `واحد ${i + 1}`), prev: 0, current: 0 })),
                        periodInfo: { name: '', date: '', totalBill: 0 },
                        settings: {
                            calculationMode: 'manual',
                            manualTiers: [{ to: 5, rate: 1000 }, { to: 10, rate: 1500 }, { to: Infinity, rate: 2000 }],
                            autoTiers: [{ to: 10, coefficient: 1 }, { to: 20, coefficient: 1.5 }, { to: Infinity, coefficient: 2 }]
                        }
                    };
                    saveState();
                }
            } catch (error) {
                console.error('Failed to load or parse state:', error);
                showMessage('خطا در خواندن اطلاعات. ممکن است داده‌ها آسیب دیده باشند.', { icon: 'error' });
            }
        }

        function saveHistory(periodData) {
            try {
                const history = getHistory();
                const existingIndex = history.findIndex(p => p.period_name === periodData.period_name && p.bill_date === periodData.bill_date);
                if (existingIndex > -1) {
                    history[existingIndex] = periodData;
                } else {
                    periodData.id = Date.now();
                    history.unshift(periodData);
                }
                localStorage.setItem(DB_HISTORY_KEY, JSON.stringify(history));
                return true;
            } catch (error) {
                console.error('Failed to save history:', error);
                return false;
            }
        }

        function getHistory() {
            try {
                const history = localStorage.getItem(DB_HISTORY_KEY);
                return history ? JSON.parse(history) : [];
            } catch (error) {
                console.error('Failed to get history:', error);
                return [];
            }
        }

        // --- RENDER FUNCTIONS ---
        function render() {
            renderControls();
            renderTable();
            calculateAll();
            lucide.createIcons();
        }

        function renderControls() {
            DOM.periodNameInput.value = state.periodInfo.name || '';
            DOM.billDateInput.value = state.periodInfo.date || '';
            DOM.totalBillAmountInput.value = state.periodInfo.totalBill > 0 ? formatNumber(state.periodInfo.totalBill) : '';
        }

        function renderTable() {
            DOM.tableBody.innerHTML = state.units.map(unit => `
                <tr class="text-sm hover:bg-gray-50/50 transition-colors duration-200" data-id="${unit.id}">
                    <td class="p-4">${formatNumber(unit.id)}</td>
                    <td class="p-4 text-right">${unit.name}</td>
                    <td class="p-2 md:p-4"><input type="text" inputmode="numeric" class="input-field text-center" data-field="prev" value="${formatNumber(unit.prev)}"></td>
                    <td class="p-2 md:p-4"><input type="text" inputmode="numeric" class="input-field text-center" data-field="current" value="${formatNumber(unit.current)}"></td>
                    <td class="p-4 font-semibold consumption-cell">۰</td>
                    <td class="p-4 tier-cell">-</td>
                    <td class="p-4 font-bold amount-cell">۰</td>
                </tr>
            `).join('');
        }

        function renderSettingsModal() {
            const mode = state.settings.calculationMode;
            document.querySelector(`input[name="calc-mode"][value="${mode}"]`).checked = true;

            const renderTiers = (container, tiers, mode) => {
                const isManual = mode === 'manual';
                container.innerHTML = (tiers || []).map((tier, index) => {
                    const fromValue = index === 0 ? 0 : (tiers[index - 1]?.to || 0);
                    return `
                    <div class="tier-row grid grid-cols-12 gap-2 items-center p-2 rounded-lg bg-gray-50" data-index="${index}">
                        <div class="col-span-1 text-sm font-bold text-gray-500">${formatNumber(index + 1)}</div>
                        <div class="col-span-3">
                            <label class="text-xs text-gray-500">از (متر مکعب)</label>
                            <input type="text" class="input-field text-sm" value="${formatNumber(fromValue)}" readonly>
                        </div>
                        <div class="col-span-3">
                            <label class="text-xs text-gray-500">تا (متر مکعب)</label>
                            <input type="text" inputmode="numeric" class="input-field text-sm" data-tier-field="to" placeholder="∞" value="${tier.to === Infinity || tier.to === null ? '' : formatNumber(tier.to)}">
                        </div>
                        <div class="col-span-4">
                            <label class="text-xs text-gray-500">${isManual ? 'تعرفه (تومان)' : 'ضریب'}</label>
                            <input type="text" inputmode="numeric" class="input-field text-sm" data-tier-field="${isManual ? 'rate' : 'coefficient'}" value="${tier[isManual ? 'rate' : 'coefficient'] ? formatNumber(tier[isManual ? 'rate' : 'coefficient']) : ''}">
                        </div>
                        <div class="col-span-1 flex justify-end">
                            <button class="remove-tier-btn text-red-400 hover:text-red-600 mt-5" data-mode="${mode}"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </div>
                    </div>`;
                }).join('');
            };

            renderTiers(DOM.manualTiersContainer, state.settings.manualTiers, 'manual');
            renderTiers(DOM.autoTiersContainer, state.settings.autoTiers, 'auto');
            updateSettingsView();
            lucide.createIcons();
        }

        function updateSettingsView() {
            const mode = document.querySelector('input[name="calc-mode"]:checked').value;
            document.querySelectorAll('input[name="calc-mode"]').forEach(radio => {
                const label = radio.parentElement;
                if (radio.value === mode) {
                    label.classList.add('bg-blue-600', 'text-white', 'font-bold', 'shadow-md');
                    label.classList.remove('bg-gray-100');
                } else {
                    label.classList.remove('bg-blue-600', 'text-white', 'font-bold', 'shadow-md');
                    label.classList.add('bg-gray-100');
                }
            });
            DOM.manualSettings.style.display = mode === 'manual' ? 'block' : 'none';
            DOM.autoSettings.style.display = mode === 'auto' ? 'block' : 'none';
        }
        
        // --- CALCULATION LOGIC ---
        function calculateAll() {
            const { units, settings, periodInfo } = state;
            if (!units || !settings || !periodInfo) return;
            const totalBill = getRawNumber(periodInfo.totalBill);
            let totalConsumption = 0;

            units.forEach(unit => {
                unit.prev = getRawNumber(unit.prev);
                unit.current = getRawNumber(unit.current);
                unit.consumption = unit.current - unit.prev;
            });
            const maxConsumption = Math.max(0, ...units.map(u => u.consumption));

            if (settings.calculationMode === 'manual') {
                let totalCalculatedAmount = 0;
                units.forEach(unit => {
                    let cost = 0;
                    let tierLevel = 'پله ۱';
                    if (unit.consumption > 0) {
                        const tiers = settings.manualTiers || [];
                        let lastTierFrom = 0;
                        for(let i = 0; i < tiers.length; i++) {
                            const tier = tiers[i];
                            const tierTo = tier.to === Infinity || tier.to === null ? Infinity : getRawNumber(tier.to);
                            if (unit.consumption > lastTierFrom) {
                                tierLevel = `پله ${formatNumber(i + 1)}`;
                                const consumptionInTier = Math.min(unit.consumption - lastTierFrom, tierTo - lastTierFrom);
                                cost += consumptionInTier * getRawNumber(tier.rate);
                            }
                            lastTierFrom = tierTo;
                        }
                    }
                    unit.cost = cost;
                    unit.tier = tierLevel;
                    totalCalculatedAmount += cost;
                });

                const difference = totalBill - totalCalculatedAmount;
                const validConsumption = units.reduce((sum, u) => sum + (u.consumption > 0 ? u.consumption : 0), 0);
                units.forEach(unit => {
                    const adjustment = validConsumption > 0 && unit.consumption > 0 ? (difference / validConsumption) * unit.consumption : 0;
                    unit.finalCost = Math.max(0, unit.cost + adjustment);
                });
            } else { // auto mode
                let totalWeightedConsumption = 0;
                units.forEach(unit => {
                    let coefficient = 1;
                    let tierLevel = 'پله ۱';
                    if (unit.consumption > 0) {
                        const tiers = settings.autoTiers || [];
                        let lastTierTo = 0;
                        for (let i = 0; i < tiers.length; i++) {
                            const tier = tiers[i];
                            const tierTo = tier.to === Infinity || tier.to === null ? Infinity : getRawNumber(tier.to);
                            if (unit.consumption > lastTierTo && unit.consumption <= tierTo) {
                                coefficient = getRawNumber(tier.coefficient);
                                tierLevel = `پله ${formatNumber(i + 1)}`;
                                break;
                            }
                            lastTierTo = tierTo;
                        }
                    }
                    unit.tier = tierLevel;
                    unit.weightedConsumption = Math.max(0, unit.consumption) * coefficient;
                    totalWeightedConsumption += unit.weightedConsumption;
                });

                const baseRate = totalWeightedConsumption > 0 ? totalBill / totalWeightedConsumption : 0;
                units.forEach(unit => { unit.finalCost = unit.weightedConsumption * baseRate; });
            }

            let finalTotalAmount = 0;
            units.forEach(unit => {
                const row = DOM.tableBody.querySelector(`tr[data-id='${unit.id}']`);
                if (!row) return;
                const consumptionCell = row.querySelector('.consumption-cell');
                const tierCell = row.querySelector('.tier-cell');
                const amountCell = row.querySelector('.amount-cell');
                
                row.classList.remove('bg-red-50', 'text-red-800');
                consumptionCell.style.background = 'transparent';
                consumptionCell.style.color = 'inherit';
                consumptionCell.classList.remove('rounded-md', 'p-1', 'text-white', 'inline-block');

                if (unit.consumption < 0) {
                    row.classList.add('bg-red-50', 'text-red-800');
                    consumptionCell.textContent = 'خطا!';
                    amountCell.textContent = formatNumber(0);
                    tierCell.textContent = '-';
                } else {
                    totalConsumption += unit.consumption;
                    finalTotalAmount += unit.finalCost;
                    consumptionCell.textContent = formatNumber(unit.consumption);
                    amountCell.textContent = formatNumber(unit.finalCost);
                    tierCell.textContent = unit.tier;

                    if (maxConsumption > 0 && unit.consumption > 0) {
                        const ratio = unit.consumption / maxConsumption;
                        const hue = 120 - (ratio * 120); // Green to Red
                        consumptionCell.style.background = `hsl(${hue}, 80%, 60%)`;
                        consumptionCell.classList.add('p-1', 'text-white', 'rounded-md', 'inline-block', 'min-w-[3rem]');
                    }
                }
            });

            DOM.totalConsumption.textContent = formatNumber(totalConsumption);
            DOM.totalCalculatedAmount.textContent = formatNumber(finalTotalAmount);
            const finalDifference = totalBill - finalTotalAmount;
            DOM.differenceAmount.textContent = formatNumber(finalDifference);
            DOM.differenceAmount.parentElement.className = `font-bold text-white text-sm ${Math.abs(finalDifference) < 1 ? 'bg-green-700' : 'bg-red-700'}`;
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            const debouncedSave = debounce(saveState, 1000);

            const handleNumericInput = (e, callback) => {
                const rawValue = getRawNumber(e.target.value);
                callback(rawValue);
                e.target.value = formatNumber(rawValue);
                calculateAll();
            };

            DOM.totalBillAmountInput.addEventListener('input', e => { state.periodInfo.totalBill = getRawNumber(e.target.value); e.target.value = formatNumber(state.periodInfo.totalBill); calculateAll(); debouncedSave(); });
            DOM.periodNameInput.addEventListener('input', e => { state.periodInfo.name = e.target.value; debouncedSave(); });
            DOM.billDateInput.addEventListener('change', e => { state.periodInfo.date = e.target.value; debouncedSave(); });

            DOM.tableBody.addEventListener('input', e => {
                if (e.target.matches('input')) {
                    const id = parseInt(e.target.closest('tr').dataset.id);
                    const field = e.target.dataset.field;
                    const unit = state.units.find(u => u.id === id);
                    if (unit) {
                        handleNumericInput(e, rawValue => { unit[field] = rawValue; debouncedSave(); });
                    }
                }
            });

            document.getElementById('backup-btn').addEventListener('click', downloadBackup);
            DOM.restoreInput.addEventListener('change', restoreBackup);
            document.getElementById('save-period-btn').addEventListener('click', saveCurrentPeriod);
            document.getElementById('new-period-btn').addEventListener('click', startNewPeriod);
            document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
            document.getElementById('export-image-btn').addEventListener('click', exportToImage);
            
            document.getElementById('settings-btn').addEventListener('click', () => { renderSettingsModal(); DOM.settingsModal.classList.add('visible'); });
            document.getElementById('history-btn').addEventListener('click', showHistory);
            
            document.querySelectorAll('.modal-close-btn').forEach(btn => {
                btn.addEventListener('click', () => btn.closest('.modal-backdrop').classList.remove('visible'));
            });
            
            document.querySelectorAll('input[name="calc-mode"]').forEach(radio => radio.addEventListener('change', updateSettingsView));
            
            DOM.settingsModal.addEventListener('click', e => {
                const addBtn = e.target.closest('#add-manual-tier-btn, #add-auto-tier-btn');
                const removeBtn = e.target.closest('.remove-tier-btn');

                if (addBtn) {
                    if (addBtn.id === 'add-manual-tier-btn') {
                        state.settings.manualTiers.push({ to: Infinity, rate: 0 });
                    } else {
                        state.settings.autoTiers.push({ to: Infinity, coefficient: 1 });
                    }
                    renderSettingsModal();
                } else if (removeBtn) {
                    const { mode } = removeBtn.dataset;
                    const index = removeBtn.closest('.tier-row').dataset.index;
                    state.settings[mode === 'manual' ? 'manualTiers' : 'autoTiers'].splice(index, 1);
                    renderSettingsModal();
                }
            });

            document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
            
            DOM.actionsMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                DOM.actionsMenu.classList.toggle('hidden');
                DOM.actionsMenu.classList.toggle('scale-100');
            });
            document.addEventListener('click', (e) => {
                if (!DOM.actionsMenuBtn.contains(e.target) && !DOM.actionsMenu.contains(e.target)) {
                    DOM.actionsMenu.classList.add('hidden');
                }
            });
            DOM.actionsMenu.addEventListener('click', () => DOM.actionsMenu.classList.add('hidden'));
        }

        function saveSettings() {
            state.settings.calculationMode = document.querySelector('input[name="calc-mode"]:checked').value;
            
            const saveTiersFromContainer = (container, tierArrayName) => {
                const tiers = [];
                container.querySelectorAll('.tier-row').forEach(row => {
                    const toStr = row.querySelector('[data-tier-field="to"]').value;
                    const to = toStr === '' || toStr === '∞' ? Infinity : getRawNumber(toStr);
                    const tier = { to };
                    const valueInput = row.querySelector(`[data-tier-field="${tierArrayName === 'manualTiers' ? 'rate' : 'coefficient'}"]`);
                    tier[tierArrayName === 'manualTiers' ? 'rate' : 'coefficient'] = getRawNumber(valueInput.value);
                    tiers.push(tier);
                });
                state.settings[tierArrayName] = tiers;
            };

            saveTiersFromContainer(DOM.manualTiersContainer, 'manualTiers');
            saveTiersFromContainer(DOM.autoTiersContainer, 'autoTiers');
            
            saveState();
            calculateAll();
            DOM.settingsModal.classList.remove('visible');
            showMessage('تنظیمات با موفقیت ذخیره شد.', { icon: 'success' });
        }

        // --- ACTIONS ---
        function downloadBackup() {
            const backupData = {
                appState: state,
                appHistory: getHistory()
            };
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            const jalaliDate = new Date().toLocaleDateString('fa-IR-u-nu-latn').replace(/\//g, '-');
            link.download = `پشتیبان-آب-${jalaliDate}.json`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
            showMessage('فایل پشتیبان با موفقیت دانلود شد.', { icon: 'success' });
        }

        async function restoreBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            const confirmed = await showMessage('تمام اطلاعات فعلی با اطلاعات فایل پشتیبان جایگزین خواهد شد. آیا مطمئن هستید؟', {
                icon: 'confirm',
                buttons: [
                    { text: 'بله، بازیابی کن', class: 'btn-primary bg-orange-500 hover:bg-orange-600', resolveValue: true },
                    { text: 'خیر', class: 'btn-secondary', resolveValue: false }
                ]
            });
            if (!confirmed) { event.target.value = ''; return; }
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const restoredData = JSON.parse(e.target.result);
                    if (restoredData.appState && restoredData.appHistory !== undefined) {
                        state = restoredData.appState;
                        localStorage.setItem(DB_HISTORY_KEY, JSON.stringify(restoredData.appHistory));
                        saveState();
                        render();
                        await showMessage('اطلاعات با موفقیت بازیابی شد.', { icon: 'success' });
                    } else { throw new Error('Invalid file structure'); }
                } catch (error) {
                    await showMessage('خطا در بازیابی اطلاعات. لطفاً از یک فایل پشتیبان معتبر استفاده کنید.', { icon: 'error' });
                } finally { event.target.value = ''; }
            };
            reader.readAsText(file);
        }
        
        async function saveCurrentPeriod() {
            if (!state.periodInfo.name || !state.periodInfo.date) {
                await showMessage('لطفاً نام دوره و تاریخ قبض را مشخص کنید.', { icon: 'error' });
                return;
            }
            const periodData = {
                period_name: state.periodInfo.name,
                bill_date: state.periodInfo.date,
                total_bill: getRawNumber(state.periodInfo.totalBill),
                total_consumption: getRawNumber(DOM.totalConsumption.textContent),
                units_data: JSON.stringify(state.units)
            };
            if (saveHistory(periodData)) {
                await showMessage(`دوره "${state.periodInfo.name}" با موفقیت در تاریخچه ذخیره شد.`, { icon: 'success' });
            } else {
                await showMessage('خطا در ذخیره تاریخچه.', { icon: 'error' });
            }
        }

        async function startNewPeriod() {
            const confirmed = await showMessage('قرائت فعلی به عنوان قرائت قبلی ثبت می‌شود و اطلاعات دوره پاک می‌شود. آیا مطمئن هستید؟', {
                icon: 'confirm',
                buttons: [
                    { text: 'بله، دوره جدید', class: 'btn-primary bg-green-600 hover:bg-green-700', resolveValue: true },
                    { text: 'خیر', class: 'btn-secondary bg-red-500 hover:bg-red-600 text-white', resolveValue: false }
                ]
            });
            if (!confirmed) return;

            state.units.forEach(unit => { unit.prev = unit.current; unit.current = 0; });
            state.periodInfo = { name: '', date: '', totalBill: 0 };
            saveState();
            render();
            await showMessage('دوره جدید با موفقیت آغاز شد.', { icon: 'success' });
        }

        function showHistory() {
            const history = getHistory();
            if (!history || history.length === 0) {
                DOM.historyContainer.innerHTML = '<div class="text-center text-slate-500 py-8 flex flex-col items-center gap-4"><i data-lucide="archive-x" class="w-16 h-16 text-gray-300"></i><p>هنوز دوره‌ای ذخیره نشده است.</p></div>';
            } else {
                DOM.historyContainer.innerHTML = `<div class="space-y-3">${history.map(p => `
                    <div class="p-4 bg-slate-50 rounded-lg flex justify-between items-center border hover:shadow-md hover:border-blue-300 transition-all duration-300">
                        <div>
                            <strong class="text-slate-800">${p.period_name} (${p.bill_date})</strong>
                            <div class="text-sm text-slate-600 mt-1">
                                <span>مصرف کل: ${formatNumber(p.total_consumption)}</span> | 
                                <span>مبلغ کل: ${formatNumber(p.total_bill)} تومان</span>
                            </div>
                        </div>
                        <button class="btn btn-secondary" data-id="${p.id}">بارگذاری</button>
                    </div>`).join('')}</div>`;
                
                DOM.historyContainer.querySelectorAll('button').forEach(btn => btn.addEventListener('click', async e => {
                    const confirmed = await showMessage('اطلاعات فعلی با اطلاعات این دوره جایگزین خواهد شد. آیا می‌خواهید این دوره بارگذاری شود؟', {
                        icon: 'confirm',
                        buttons: [
                            { text: 'بله', class: 'btn-primary', resolveValue: true },
                            { text: 'خیر', class: 'btn-secondary', resolveValue: false }
                        ]
                    });
                    if(confirmed){
                        const periodToLoad = history.find(p => p.id == e.target.dataset.id);
                        if (periodToLoad) {
                            state.units = JSON.parse(periodToLoad.units_data);
                            state.periodInfo = { name: periodToLoad.period_name, date: periodToLoad.bill_date, totalBill: periodToLoad.total_bill };
                            saveState();
                            render();
                            DOM.historyModal.classList.remove('visible');
                        }
                    }
                }));
            }
            lucide.createIcons();
            DOM.historyModal.classList.add('visible');
        }

        function exportToExcel() {
            const table = document.getElementById('main-table');
            const wb = XLSX.utils.table_to_book(table, {sheet: "گزارش"});
            const periodName = state.periodInfo.name || 'دوره';
            const billDate = state.periodInfo.date || new Date().toLocaleDateString('fa-IR-u-nu-latn').replace(/\//g, '-');
            const fileName = `${periodName} - ${billDate}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        async function exportToImage() {
            displayModal('در حال آماده‌سازی تصویر...', '', 'loading');
            await new Promise(resolve => setTimeout(resolve, 50));

            try {
                const exportContainer = document.getElementById('image-export-container');
                const periodName = state.periodInfo.name || 'نامشخص';
                const billDate = state.periodInfo.date || 'بی‌تاریخ';
                const totalBill = DOM.totalBillAmountInput.value || '۰';

                const tableClone = document.getElementById('main-table').cloneNode(true);
                tableClone.querySelectorAll('input').forEach(input => {
                    const cell = input.parentElement;
                    cell.textContent = input.value;
                    cell.classList.add('p-3');
                });

                const reportCard = document.createElement('div');
                reportCard.style.width = '800px';
                reportCard.className = 'p-6 bg-white border rounded-xl shadow-lg font-sans';
                reportCard.innerHTML = `
                    <div class="flex justify-between items-center mb-4 pb-3 border-b">
                        <h2 class="text-xl font-bold text-gray-800">گزارش قبض آب</h2>
                        <div class="text-sm text-gray-600 text-left">
                            <p><strong>نام دوره:</strong> ${periodName}</p>
                            <p><strong>تاریخ قبض:</strong> ${billDate}</p>
                            <p><strong>مبلغ کل:</strong> ${totalBill} تومان</p>
                        </div>
                    </div>
                    <div class="overflow-x-auto rounded-lg border">
                        ${tableClone.outerHTML}
                    </div>
                `;
                
                exportContainer.innerHTML = '';
                exportContainer.appendChild(reportCard);

                const canvas = await html2canvas(reportCard, { scale: 2, useCORS: true });
                const link = document.createElement('a');
                link.download = `گزارش-${periodName}-${billDate}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();

                exportContainer.innerHTML = '';
                hideModal();
                await showMessage('فایل تصویر با موفقیت ساخته شد.', { icon: 'success' });

            } catch (error) {
                console.error("Image generation failed:", error);
                hideModal();
                await showMessage("خطا در ساخت فایل تصویر.", { icon: 'error' });
            }
        }

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function initializeApp() {
            loadState();
            setupEventListeners();
            render();
            jalaliDatepicker.startWatch({
                persianDigits: true,
                showTodayBtn: true,
                showEmptyBtn: true,
            });
        }

        initializeApp();
    };
    </script>
</body>
</html>
