<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت هوشمند قبض آب</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Jalali Date Picker -->
    <link rel="stylesheet" href="https://unpkg.com/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.css">
    <script type="text/javascript" src="https://unpkg.com/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.js"></script>
    
    <!-- Vazirmatn Font -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

    <!-- jsPDF for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Vazirmatn Font for jsPDF (Base64 encoded) -->
    <script src="https://cdn.jsdelivr.net/gh/alireza-ab/sahel-font@gh-pages/dist/vazir.js"></script>

    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style type="text/tailwindcss">
        @layer components {
            .action-btn {
                @apply flex items-center gap-2 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-300 hover:shadow-md transition-all duration-300;
            }
            .form-input {
                @apply w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition;
            }
            .menu-item {
                @apply block w-full text-right px-4 py-2 text-sm text-gray-700 hover:bg-gray-100;
            }
            .modal-backdrop {
                @apply fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300;
            }
            .modal-backdrop.visible {
                @apply opacity-100 pointer-events-auto;
            }
            .modal-content {
                @apply bg-white rounded-xl shadow-2xl p-6 relative w-full transform scale-95 transition-transform duration-300;
            }
            .modal-backdrop.visible .modal-content {
                @apply scale-100;
            }
            .modal-close-btn {
                @apply absolute top-4 left-4 text-gray-400 hover:text-gray-800 text-2xl font-bold;
            }
        }
    </style>
    
    <style>
        body, input, button, select, textarea {
            font-family: 'Vazirmatn', sans-serif;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #aab5c0; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #888; }
        #main-table th, #main-table td { padding: 0.6rem 0.5rem; font-size: 0.9rem; }
        #main-table input { width: 100%; min-width: 6rem; padding: 0.4rem; font-size: 0.9rem; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-6 max-w-7xl">
        
        <!-- Header -->
        <header class="flex justify-between items-center mb-6 pb-4 border-b-2 border-blue-600">
            <div class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path><path d="M12 22.07V12.5l-5.66-5.66"></path></svg>
                <h1 class="text-2xl md:text-3xl font-bold text-blue-700">مدیریت هوشمند قبض آب</h1>
            </div>
            <div class="flex items-center gap-2 relative">
                <button id="settings-btn" class="action-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    <span>تنظیمات</span>
                </button>
                <button id="history-btn" class="action-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="m19 9-5 5-4-4-3 3"></path></svg>
                    <span>تاریخچه</span>
                </button>
                <div class="relative">
                    <button id="actions-menu-btn" class="action-btn bg-blue-600 text-white hover:bg-blue-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M3 12h18"></path><path d="M3 18h18"></path></svg>
                        <span>عملیات</span>
                    </button>
                    <div id="actions-menu" class="absolute top-full mt-2 left-0 w-56 bg-white rounded-lg shadow-xl border hidden z-10">
                        <ul class="text-gray-700 py-1">
                            <li><a href="#" id="save-period-btn" class="menu-item">ذخیره دوره</a></li>
                            <li><a href="#" id="new-period-btn" class="menu-item">شروع دوره جدید</a></li>
                            <li class="border-t my-1"></li>
                            <li><a href="#" id="export-pdf-btn" class="menu-item">خروجی PDF</a></li>
                            <li><a href="#" id="export-excel-btn" class="menu-item">خروجی Excel</a></li>
                            <li class="border-t my-1"></li>
                            <li><a href="#" id="backup-btn" class="menu-item">دریافت پشتیبان</a></li>
                            <li><label for="restore-input" class="menu-item cursor-pointer">بازیابی پشتیبان</label></li>
                        </ul>
                        <input type="file" id="restore-input" accept=".json" class="hidden">
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="bg-white p-4 md:p-6 rounded-xl shadow-lg">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label for="period-name" class="font-semibold mb-1 block text-gray-600">نام دوره:</label>
                    <input type="text" id="period-name" placeholder="مثال: تابستان ۱۴۰۳" class="form-input">
                </div>
                <div>
                    <label for="bill-date" class="font-semibold mb-1 block text-gray-600">تاریخ قبض:</label>
                    <input type="text" id="bill-date" data-jdp placeholder="تاریخ را انتخاب کنید" class="form-input">
                </div>
                <div>
                    <label for="total-bill-amount" class="font-semibold mb-1 block text-gray-600">مبلغ کل قبض (تومان):</label>
                    <input type="text" id="total-bill-amount" placeholder="مبلغ کل" inputmode="numeric" class="form-input">
                </div>
            </div>

            <div class="overflow-x-auto rounded-lg border">
                <table id="main-table" class="w-full text-center">
                    <thead class="bg-gray-700 text-white text-sm">
                        <tr>
                            <th class="p-3">واحد</th>
                            <th class="p-3">نام</th>
                            <th class="p-3">قرائت قبلی</th>
                            <th class="p-3">قرائت فعلی</th>
                            <th class="p-3">مصرف (متر مکعب)</th>
                            <th class="p-3">پله</th>
                            <th class="p-3">مبلغ (تومان)</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-gray-200"></tbody>
                    <tfoot class="font-bold text-white text-sm">
                        <tr class="bg-gray-600">
                            <td colspan="4" class="p-3">جمع کل</td>
                            <td id="total-consumption" class="p-3">۰</td>
                            <td class="p-3"></td>
                            <td id="total-calculated-amount" class="p-3">۰</td>
                        </tr>
                        <tr class="bg-gray-800">
                            <td colspan="5" class="p-3">مابه التفاوت</td>
                            <td colspan="2" id="difference-amount" class="p-3">۰</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="settings-modal" class="modal-backdrop">
        <div class="modal-content max-w-2xl">
            <button class="modal-close-btn">&times;</button>
            <h2 class="text-xl font-bold mb-2 text-gray-800">تنظیمات محاسبه هزینه</h2>
            <p class="text-sm text-gray-500 mb-6">در این بخش می‌توانید روش محاسبه و تعرفه پله‌های مصرف را تعیین کنید.</p>
            
            <div class="mb-4 p-1 bg-gray-100 rounded-lg flex justify-center gap-2">
                <label class="w-full text-center py-2 rounded-md cursor-pointer transition"><input type="radio" name="calc-mode" value="manual" class="hidden"> پلکانی دستی</label>
                <label class="w-full text-center py-2 rounded-md cursor-pointer transition"><input type="radio" name="calc-mode" value="auto" class="hidden"> تنظیم خودکار</label>
            </div>

            <div id="manual-settings">
                <div id="manual-tiers-container" class="space-y-3"></div>
                <button id="add-manual-tier-btn" class="mt-4 flex items-center gap-2 text-sm text-blue-600 hover:text-blue-800 font-semibold">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    افزودن پلکان
                </button>
            </div>
            <div id="auto-settings" class="hidden">
                <div id="auto-tiers-container" class="space-y-3"></div>
                <button id="add-auto-tier-btn" class="mt-4 flex items-center gap-2 text-sm text-blue-600 hover:text-blue-800 font-semibold">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    افزودن پلکان
                </button>
            </div>
            <hr class="my-6">
            <button id="save-settings-btn" class="w-full bg-green-600 text-white py-2.5 rounded-lg shadow hover:bg-green-700 transition font-bold">ذخیره تنظیمات</button>
        </div>
    </div>

    <div id="history-modal" class="modal-backdrop">
        <div class="modal-content max-w-xl max-h-[80vh] flex flex-col">
            <button class="modal-close-btn">&times;</button>
            <h2 class="text-xl font-bold mb-4 text-gray-800">تاریخچه دوره‌ها</h2>
            <div id="history-container" class="overflow-y-auto pr-2"></div>
        </div>
    </div>
    
    <div id="message-modal" class="modal-backdrop z-[100]">
        <div class="modal-content max-w-sm text-center">
            <p id="message-text" class="mb-6 text-gray-700"></p>
            <div id="message-buttons" class="flex justify-center gap-4"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // [اصلاح شده] آدرس دهی به پوشه api که در کنار فایل index.html قرار دارد
            const API_URL = '';

            const DOM = {
                tableBody: document.getElementById('table-body'),
                totalConsumption: document.getElementById('total-consumption'),
                totalCalculatedAmount: document.getElementById('total-calculated-amount'),
                differenceAmount: document.getElementById('difference-amount'),
                periodNameInput: document.getElementById('period-name'),
                billDateInput: document.getElementById('bill-date'),
                totalBillAmountInput: document.getElementById('total-bill-amount'),
                actionsMenuBtn: document.getElementById('actions-menu-btn'),
                actionsMenu: document.getElementById('actions-menu'),
                restoreInput: document.getElementById('restore-input'),
                // Modals
                settingsModal: document.getElementById('settings-modal'),
                historyModal: document.getElementById('history-modal'),
                messageModal: document.getElementById('message-modal'),
                // Settings Modal elements
                manualSettings: document.getElementById('manual-settings'),
                autoSettings: document.getElementById('auto-settings'),
                manualTiersContainer: document.getElementById('manual-tiers-container'),
                autoTiersContainer: document.getElementById('auto-tiers-container'),
                // History Modal elements
                historyContainer: document.getElementById('history-container'),
                // Message Modal elements
                messageText: document.getElementById('message-text'),
                messageButtons: document.getElementById('message-buttons'),
            };

            let state = {};

            const toEnglishDigits = str => String(str).replace(/[\u0660-\u0669\u06F0-\u06F9]/g, c => c.charCodeAt(0) & 0xf);
            const getRawNumber = formattedStr => parseFloat(toEnglishDigits(String(formattedStr)).replace(/[,٬]/g, '')) || 0;
            const formatNumber = num => isNaN(num) ? '۰' : Math.round(num).toLocaleString('fa-IR');

            function showMessage(text, buttons = [{ text: 'باشه', class: 'bg-blue-500', resolveValue: true }]) {
                return new Promise(resolve => {
                    DOM.messageText.textContent = text;
                    DOM.messageButtons.innerHTML = '';
                    buttons.forEach(btnInfo => {
                        const button = document.createElement('button');
                        button.textContent = btnInfo.text;
                        button.className = `text-white px-6 py-2 rounded-lg shadow hover:opacity-90 transition ${btnInfo.class}`;
                        button.onclick = () => { DOM.messageModal.classList.remove('visible'); resolve(btnInfo.resolveValue); };
                        DOM.messageButtons.appendChild(button);
                    });
                    DOM.messageModal.classList.add('visible');
                });
            }

            async function apiCall(endpoint, options = {}) {
                try {
                    const response = await fetch(API_URL + endpoint, options);
                    const responseText = await response.text(); // Always read as text first
                    if (!response.ok) {
                        // Throw the raw text as error, it might be XML or something else
                        throw new Error(responseText || `Network response was not ok (${response.status})`);
                    }
                    // Try to parse as JSON, if it fails, the catch block will handle it
                    return JSON.parse(responseText);
                } catch (error) {
                    console.error(`API call to ${endpoint} failed:`, error);
                    let errorMessage = `خطا در ارتباط با سرور: ${error.message}. لطفاً اتصال اینترنت خود را بررسی کنید.`;
                    if (error instanceof SyntaxError) {
                        errorMessage = "پاسخ دریافت شده از سرور در فرمت صحیح (JSON) نیست.";
                    }
                    showMessage(errorMessage);
                    throw error;
                }
            }

            const saveState = () => apiCall('save_data.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(state),
            });

            async function loadState() {
                try {
                    const serverState = await apiCall('get_data.php');
                    if (!serverState.units || !serverState.settings || !serverState.periodInfo) {
                        throw new Error('Invalid data structure from server');
                    }
                    state = serverState;
                } catch (error) {
                    state = {
                        units: Array.from({ length: 66 }, (_, i) => ({ id: i + 1, name: i === 64 ? 'عمومی' : (i === 65 ? 'تجاری' : `واحد ${i + 1}`), prev: 0, current: 0 })),
                        periodInfo: { name: '', date: '', totalBill: 0 },
                        settings: { calculationMode: 'manual', manualTiers: [{ to: 5, rate: 1000 }, { to: 10, rate: 1500 }], autoTiers: [{ to: 10, coefficient: 1 }, { to: 20, coefficient: 1.5 }] }
                    };
                }
            }
            
            function render() {
                renderControls();
                renderTable();
                calculateAll();
            }

            function renderControls() {
                DOM.periodNameInput.value = state.periodInfo.name || '';
                DOM.billDateInput.value = state.periodInfo.date || '';
                DOM.totalBillAmountInput.value = state.periodInfo.totalBill > 0 ? formatNumber(state.periodInfo.totalBill) : '';
            }

            function renderTable() {
                DOM.tableBody.innerHTML = state.units.map(unit => `
                    <tr class="text-sm" data-id="${unit.id}">
                        <td class="p-3">${formatNumber(unit.id)}</td>
                        <td class="p-3 text-right">${unit.name}</td>
                        <td class="p-3"><input type="text" inputmode="numeric" class="form-input text-center" data-field="prev" value="${formatNumber(unit.prev)}"></td>
                        <td class="p-3"><input type="text" inputmode="numeric" class="form-input text-center" data-field="current" value="${formatNumber(unit.current)}"></td>
                        <td class="p-3 font-semibold consumption-cell">۰</td>
                        <td class="p-3 tier-cell">-</td>
                        <td class="p-3 font-bold amount-cell">۰</td>
                    </tr>
                `).join('');
            }

            function renderSettingsModal() {
                const mode = state.settings.calculationMode;
                document.querySelector(`input[name="calc-mode"][value="${mode}"]`).checked = true;
                
                const renderTiers = (container, tiers, mode) => {
                    const isManual = mode === 'manual';
                    container.innerHTML = (tiers || []).map((tier, index) => {
                        const fromValue = index === 0 ? 0 : (tiers[index - 1]?.to || 0);
                        return `
                        <div class="tier-row grid grid-cols-12 gap-2 items-center p-2 rounded-lg bg-gray-50" data-index="${index}">
                            <div class="col-span-1 text-sm font-bold text-gray-500">پله ${formatNumber(index + 1)}</div>
                            <div class="col-span-3">
                                <label class="text-xs text-gray-500">از (متر مکعب)</label>
                                <input type="text" class="w-full p-2 border rounded-md bg-white" value="${formatNumber(fromValue)}" readonly>
                            </div>
                            <div class="col-span-3">
                                <label class="text-xs text-gray-500">تا (متر مکعب)</label>
                                <input type="text" inputmode="numeric" class="w-full p-2 border rounded-md bg-white" data-tier-field="to" placeholder="∞" value="${tier.to === Infinity || tier.to === null ? '' : formatNumber(tier.to)}">
                            </div>
                            <div class="col-span-4">
                                <label class="text-xs text-gray-500">${isManual ? 'تعرفه (تومان)' : 'ضریب'}</label>
                                <input type="text" inputmode="numeric" class="w-full p-2 border rounded-md bg-white" data-tier-field="${isManual ? 'rate' : 'coefficient'}" value="${tier[isManual ? 'rate' : 'coefficient'] ? formatNumber(tier[isManual ? 'rate' : 'coefficient']) : ''}">
                            </div>
                            <div class="col-span-1 flex justify-end">
                                <button class="remove-tier-btn text-red-400 hover:text-red-600 mt-5" data-mode="${mode}">&times;</button>
                            </div>
                        </div>`;
                    }).join('');
                };
                
                renderTiers(DOM.manualTiersContainer, state.settings.manualTiers, 'manual');
                renderTiers(DOM.autoTiersContainer, state.settings.autoTiers, 'auto');
                updateSettingsView();
            }
            
            function updateSettingsView() {
                const mode = document.querySelector('input[name="calc-mode"]:checked').value;
                document.querySelectorAll('input[name="calc-mode"]').forEach(radio => {
                    const label = radio.parentElement;
                    if (radio.value === mode) {
                        label.classList.add('bg-blue-600', 'text-white', 'font-bold', 'shadow-md');
                        label.classList.remove('bg-gray-100');
                    } else {
                        label.classList.remove('bg-blue-600', 'text-white', 'font-bold', 'shadow-md');
                        label.classList.add('bg-gray-100');
                    }
                });
                DOM.manualSettings.style.display = mode === 'manual' ? 'block' : 'none';
                DOM.autoSettings.style.display = mode === 'auto' ? 'block' : 'none';
            }

            function calculateAll() {
                // Calculation logic remains the same as previous correct version
                const { units, settings, periodInfo } = state;
                if (!units || !settings || !periodInfo) return; 
                const totalBill = getRawNumber(periodInfo.totalBill);
                let totalConsumption = 0;
                
                units.forEach(unit => { 
                    unit.prev = getRawNumber(unit.prev);
                    unit.current = getRawNumber(unit.current);
                    unit.consumption = unit.current - unit.prev; 
                });
                const maxConsumption = Math.max(0, ...units.map(u => u.consumption));

                if (settings.calculationMode === 'manual') {
                    let totalCalculatedAmount = 0;
                    units.forEach(unit => {
                        let cost = 0;
                        let tierLevel = 'پله ۱';
                        if (unit.consumption > 0) {
                            let remaining = unit.consumption;
                            const tiers = settings.manualTiers || [];
                            tiers.forEach((tier, index) => {
                                const tierFrom = index === 0 ? 0 : (tiers[index-1]?.to || 0);
                                if (unit.consumption > tierFrom) tierLevel = `پله ${formatNumber(index + 1)}`;
                                if (remaining <= 0) return;
                                const tierTo = tier.to === 'Infinity' || tier.to === null ? Infinity : getRawNumber(tier.to);
                                const consumptionInTier = Math.min(remaining, tierTo - tierFrom);
                                cost += consumptionInTier * getRawNumber(tier.rate);
                                remaining -= consumptionInTier;
                            });
                        }
                        unit.cost = cost;
                        unit.tier = tierLevel;
                        totalCalculatedAmount += cost;
                    });
                    
                    const difference = totalBill - totalCalculatedAmount;
                    const validConsumption = units.reduce((sum, u) => sum + (u.consumption > 0 ? u.consumption : 0), 0);
                    units.forEach(unit => {
                        const adjustment = validConsumption > 0 && unit.consumption > 0 ? (difference / validConsumption) * unit.consumption : 0;
                        unit.finalCost = Math.max(0, unit.cost + adjustment);
                    });
                } else { // auto mode
                    let totalWeightedConsumption = 0;
                    units.forEach(unit => {
                        let coefficient = 1;
                        let tierLevel = 'پله ۱';
                        if (unit.consumption > 0) {
                            const tiers = settings.autoTiers || [];
                            const applicableTier = tiers.find((t, i) => {
                                const tierFrom = i === 0 ? 0 : (tiers[i-1]?.to || 0);
                                if (unit.consumption > tierFrom) tierLevel = `پله ${formatNumber(i + 1)}`;
                                const tierTo = t.to === 'Infinity' || t.to === null ? Infinity : getRawNumber(t.to);
                                return unit.consumption > tierFrom && unit.consumption <= tierTo;
                            }) || tiers[tiers.length - 1];
                            if (applicableTier) coefficient = getRawNumber(applicableTier.coefficient);
                        }
                        unit.tier = tierLevel;
                        unit.weightedConsumption = Math.max(0, unit.consumption) * coefficient;
                        totalWeightedConsumption += unit.weightedConsumption;
                    });

                    const baseRate = totalWeightedConsumption > 0 ? totalBill / totalWeightedConsumption : 0;
                    units.forEach(unit => { unit.finalCost = unit.weightedConsumption * baseRate; });
                }
                
                let finalTotalAmount = 0;
                units.forEach(unit => {
                    const row = DOM.tableBody.querySelector(`tr[data-id='${unit.id}']`);
                    if (!row) return;
                    const consumptionCell = row.querySelector('.consumption-cell');
                    const tierCell = row.querySelector('.tier-cell');
                    const amountCell = row.querySelector('.amount-cell');
                    
                    row.classList.remove('bg-red-100', 'text-red-800');
                    consumptionCell.style.backgroundColor = 'transparent';
                    consumptionCell.style.color = 'inherit';
                    consumptionCell.classList.remove('rounded-md', 'p-1', 'text-white');

                    if (unit.consumption < 0) {
                        row.classList.add('bg-red-100', 'text-red-800');
                        consumptionCell.textContent = 'خطا!';
                        amountCell.textContent = formatNumber(0);
                        tierCell.textContent = '-';
                    } else {
                        totalConsumption += unit.consumption;
                        finalTotalAmount += unit.finalCost;
                        consumptionCell.textContent = formatNumber(unit.consumption);
                        amountCell.textContent = formatNumber(unit.finalCost);
                        tierCell.textContent = unit.tier;

                        if (maxConsumption > 0 && unit.consumption > 0) {
                            const ratio = unit.consumption / maxConsumption;
                            const hue = 120 - (ratio * 120);
                            consumptionCell.style.backgroundColor = `hsl(${hue}, 80%, 60%)`;
                            consumptionCell.classList.add('p-1', 'text-white', 'rounded-md');
                        }
                    }
                });

                DOM.totalConsumption.textContent = formatNumber(totalConsumption);
                DOM.totalCalculatedAmount.textContent = formatNumber(finalTotalAmount);
                const finalDifference = totalBill - finalTotalAmount;
                DOM.differenceAmount.textContent = formatNumber(finalDifference);
                DOM.differenceAmount.parentElement.className = `font-bold text-white text-sm ${Math.abs(finalDifference) < 1 ? 'bg-green-700' : 'bg-red-700'}`;
            }

            function setupEventListeners() {
                const debouncedSave = debounce(saveState, 1500); 

                const handleNumericInput = (e, callback) => {
                    const rawValue = getRawNumber(e.target.value);
                    callback(rawValue);
                    e.target.value = formatNumber(rawValue);
                    calculateAll();
                };

                DOM.totalBillAmountInput.addEventListener('input', e => { state.periodInfo.totalBill = getRawNumber(e.target.value); e.target.value = formatNumber(state.periodInfo.totalBill); calculateAll(); debouncedSave(); });
                DOM.periodNameInput.addEventListener('input', e => { state.periodInfo.name = e.target.value; debouncedSave(); });
                DOM.billDateInput.addEventListener('input', e => { state.periodInfo.date = e.target.value; debouncedSave(); });

                DOM.tableBody.addEventListener('input', e => {
                    if (e.target.matches('input')) {
                        const id = parseInt(e.target.closest('tr').dataset.id);
                        const field = e.target.dataset.field;
                        const unit = state.units.find(u => u.id === id);
                        if (unit) {
                            handleNumericInput(e, rawValue => { unit[field] = rawValue; debouncedSave(); });
                        }
                    }
                });
                
                document.getElementById('backup-btn').addEventListener('click', downloadBackup);
                DOM.restoreInput.addEventListener('change', restoreBackup);
                document.getElementById('save-period-btn').addEventListener('click', saveCurrentPeriod);
                document.getElementById('new-period-btn').addEventListener('click', startNewPeriod);
                document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);
                document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
                
                document.getElementById('settings-btn').addEventListener('click', () => { renderSettingsModal(); DOM.settingsModal.classList.add('visible'); });
                document.getElementById('history-btn').addEventListener('click', showHistory);
                
                document.querySelectorAll('.modal-close-btn').forEach(btn => {
                    btn.addEventListener('click', () => btn.closest('.modal-backdrop').classList.remove('visible'));
                });
                
                document.querySelectorAll('input[name="calc-mode"]').forEach(radio => radio.addEventListener('change', updateSettingsView));
                
                DOM.settingsModal.addEventListener('click', e => {
                    if (e.target.id === 'add-manual-tier-btn') {
                        state.settings.manualTiers.push({ to: Infinity, rate: 0 });
                        renderSettingsModal();
                    } else if (e.target.id === 'add-auto-tier-btn') {
                        state.settings.autoTiers.push({ to: Infinity, coefficient: 1 });
                        renderSettingsModal();
                    } else if (e.target.classList.contains('remove-tier-btn')) {
                        const { mode } = e.target.dataset;
                        const index = e.target.closest('.tier-row').dataset.index;
                        state.settings[mode === 'manual' ? 'manualTiers' : 'autoTiers'].splice(index, 1);
                        renderSettingsModal();
                    }
                });

                document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
                
                DOM.actionsMenuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    DOM.actionsMenu.classList.toggle('hidden');
                });
                document.addEventListener('click', (e) => {
                    if (!DOM.actionsMenuBtn.contains(e.target) && !DOM.actionsMenu.contains(e.target)) {
                        DOM.actionsMenu.classList.add('hidden');
                    }
                });
                DOM.actionsMenu.addEventListener('click', () => DOM.actionsMenu.classList.add('hidden'));
            }

            function saveSettings() {
                state.settings.calculationMode = document.querySelector('input[name="calc-mode"]:checked').value;
                
                const saveTiersFromContainer = (container, tierArrayName) => {
                    const tiers = [];
                    container.querySelectorAll('.tier-row').forEach(row => {
                        const toStr = row.querySelector('[data-tier-field="to"]').value;
                        const to = toStr === '' || toStr === '∞' ? Infinity : getRawNumber(toStr);
                        const tier = { to };
                        const valueInput = row.querySelector(`[data-tier-field="${tierArrayName === 'manualTiers' ? 'rate' : 'coefficient'}"]`);
                        tier[tierArrayName === 'manualTiers' ? 'rate' : 'coefficient'] = getRawNumber(valueInput.value);
                        tiers.push(tier);
                    });
                    state.settings[tierArrayName] = tiers;
                };

                saveTiersFromContainer(DOM.manualTiersContainer, 'manualTiers');
                saveTiersFromContainer(DOM.autoTiersContainer, 'autoTiers');
                
                saveState().then(() => {
                    calculateAll();
                    DOM.settingsModal.classList.remove('visible');
                    showMessage('تنظیمات با موفقیت ذخیره شد.');
                });
            }

            function downloadBackup() {
                const dataStr = JSON.stringify(state, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                const jalaliDate = new Date().toLocaleDateString('fa-IR-u-nu-latn').replace(/\//g, '-');
                link.download = `پشتیبان آب - ${jalaliDate}.json`;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
                showMessage('فایل پشتیبان با موفقیت دانلود شد.');
            }

            async function restoreBackup(event) {
                const file = event.target.files[0];
                if (!file) return;
                const confirmed = await showMessage('آیا مطمئن هستید؟ تمام اطلاعات فعلی با اطلاعات فایل پشتیبان جایگزین خواهد شد.', [
                    { text: 'بله، بازیابی کن', class: 'bg-orange-500', resolveValue: true },
                    { text: 'خیر', class: 'bg-slate-500', resolveValue: false }
                ]);
                if (!confirmed) { event.target.value = ''; return; }
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const restoredState = JSON.parse(e.target.result);
                        if (restoredState.units && restoredState.settings && restoredState.periodInfo) {
                            state = restoredState;
                            await saveState();
                            render();
                            await showMessage('اطلاعات با موفقیت بازیابی و در سرور ذخیره شد.');
                        } else { throw new Error('Invalid file structure'); }
                    } catch (error) {
                        await showMessage('خطا در بازیابی اطلاعات. لطفاً از یک فایل پشتیبان معتبر استفاده کنید.');
                    } finally { event.target.value = ''; }
                };
                reader.readAsText(file);
            }
            
            async function saveCurrentPeriod() {
                if (!state.periodInfo.name || !state.periodInfo.date) {
                    await showMessage('لطفاً نام دوره و تاریخ قبض را مشخص کنید.');
                    return;
                }
                const periodData = {
                    period_name: state.periodInfo.name,
                    bill_date: state.periodInfo.date,
                    total_bill: getRawNumber(state.periodInfo.totalBill),
                    total_consumption: getRawNumber(DOM.totalConsumption.textContent),
                    units_data: JSON.stringify(state.units)
                };
                await apiCall('save_history.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(periodData)
                });
                await showMessage(`دوره "${state.periodInfo.name}" با موفقیت در تاریخچه ذخیره شد.`);
            }

            async function startNewPeriod() {
                const confirmed = await showMessage('آیا مطمئن هستید؟ قرائت فعلی به عنوان قرائت قبلی ثبت می‌شود و اطلاعات دوره پاک می‌شود.', [
                    { text: 'بله، دوره جدید', class: 'bg-green-500', resolveValue: true },
                    { text: 'خیر', class: 'bg-red-500', resolveValue: false }
                ]);
                if (!confirmed) return;

                state.units.forEach(unit => { unit.prev = unit.current; unit.current = 0; });
                state.periodInfo = { name: '', date: '', totalBill: 0 };
                await saveState(); 
                render();
                await showMessage('دوره جدید با موفقیت آغاز شد.');
            }

            async function showHistory() {
                try {
                    const history = await apiCall('get_history.php');
                    if (!history || history.length === 0) {
                        DOM.historyContainer.innerHTML = '<p class="text-center text-slate-500 py-8">هنوز دوره‌ای ذخیره نشده است.</p>';
                    } else {
                        DOM.historyContainer.innerHTML = `<div class="space-y-3">${history.map(p => `
                            <div class="p-4 bg-slate-50 rounded-lg flex justify-between items-center border">
                                <div>
                                    <strong class="text-slate-800">${p.period_name} (${p.bill_date})</strong>
                                    <div class="text-sm text-slate-600 mt-1">
                                        <span>مصرف کل: ${formatNumber(p.total_consumption)}</span> | 
                                        <span>مبلغ کل: ${formatNumber(p.total_bill)} تومان</span>
                                    </div>
                                </div>
                                <button class="load-history-btn text-sm bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 shadow" data-id="${p.id}">بارگذاری</button>
                            </div>`).join('')}</div>`;
                        
                        DOM.historyContainer.querySelectorAll('.load-history-btn').forEach(btn => btn.addEventListener('click', async e => {
                            const confirmed = await showMessage('آیا می‌خواهید این دوره بارگذاری شود؟ اطلاعات فعلی با اطلاعات این دوره جایگزین و در سرور ذخیره خواهد شد.', [
                                { text: 'بله', class: 'bg-green-500', resolveValue: true },
                                { text: 'خیر', class: 'bg-red-500', resolveValue: false }
                            ]);
                            if(confirmed){
                                const periodToLoad = history.find(p => p.id == e.target.dataset.id);
                                if (periodToLoad) {
                                    state.units = JSON.parse(periodToLoad.units_data);
                                    state.periodInfo = { name: periodToLoad.period_name, date: periodToLoad.bill_date, totalBill: periodToLoad.total_bill };
                                    await saveState(); 
                                    render();
                                    DOM.historyModal.classList.remove('visible');
                                }
                            }
                        }));
                    }
                    DOM.historyModal.classList.add('visible');
                } catch (error) {
                    // Error message is already shown by apiCall
                }
            }
            
            function exportToPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.addFileToVFS('Vazirmatn-Regular.ttf', vazir);
                doc.addFont('Vazirmatn-Regular.ttf', 'Vazirmatn', 'normal');
                doc.setFont('Vazirmatn');

                doc.text(`گزارش قبض دوره: ${state.periodInfo.name || 'نامشخص'}`, 105, 15, { align: 'center' });
                doc.text(`تاریخ: ${state.periodInfo.date || '-'} | مبلغ کل: ${formatNumber(state.periodInfo.totalBill)} تومان`, 105, 22, { align: 'center' });
                
                const tableData = state.units.map(u => [
                    formatNumber(u.finalCost),
                    u.tier,
                    formatNumber(u.consumption),
                    formatNumber(u.current),
                    formatNumber(u.prev),
                    u.name,
                    formatNumber(u.id)
                ]).reverse(); // To display correctly with RTL

                doc.autoTable({
                    startY: 30,
                    head: [['مبلغ (تومان)', 'پله', 'مصرف', 'فعلی', 'قبلی', 'نام', 'واحد']],
                    body: tableData,
                    styles: { font: 'Vazirmatn', halign: 'center' },
                    headStyles: { fillColor: [41, 128, 185], halign: 'center' },
                    columnStyles: { 
                        5: { halign: 'right' } // Align 'name' column to the right
                    },
                    didDrawPage: (data) => {
                        // Correct RTL text for body
                        doc.setLanguage('fa');
                    }
                });
                
                doc.save(`گزارش-آب-${state.periodInfo.name || 'دوره'}.pdf`);
            }

            function exportToExcel() {
                const table = document.getElementById('main-table');
                const wb = XLSX.utils.table_to_book(table, {sheet: "گزارش"});
                XLSX.writeFile(wb, `گزارش-آب-${state.periodInfo.name || 'دوره'}.xlsx`);
            }

            function debounce(func, delay) {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), delay);
                };
            }

            async function initializeApp() {
                await loadState();
                setupEventListeners();
                render();
                jalaliDatepicker.startWatch({ 
                    persianDigits: true,
                    showTodayBtn: true,
                    showEmptyBtn: true,
                });
            }

            initializeApp();
        });
    </script>
</body>
</html>

